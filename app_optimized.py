# app_smart_filter.py ‚Äî —É–º–Ω–∞—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è —Ç–µ–∫—Å—Ç–∞
import streamlit as st
import cv2
import easyocr
import pandas as pd
import re
import os
import tempfile
import time
from ultralytics import YOLO
import numpy as np
from collections import Counter

st.set_page_config(page_title="–ü—Ä–æ–ø—É—Å–∫–∏ ‚Äî –£–º–Ω–∞—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è", layout="wide")
st.title("üß† –£–º–Ω–æ–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ –ø—Ä–æ–ø—É—Å–∫–æ–≤")

# === –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ö–ï–®–ò ===
@st.cache_resource
def load_model():
    model_path = '/Users/amina.bagatyrova/Desktop/–ú–æ—ë/–ü—Ä–æ–ø—É—Å–∫–∏/runs/detect/propuska_detector5/weights/best.pt'
    return YOLO(model_path)

@st.cache_resource
def load_ocr():
    return easyocr.Reader(['ru'], gpu=False)

model = load_model()
reader = load_ocr()

# === –£–ú–ù–ê–Ø –§–ò–õ–¨–¢–†–ê–¶–ò–Ø –¢–ï–ö–°–¢–ê ===
class NameFilter:
    """–£–º–Ω—ã–π —Ñ–∏–ª—å—Ç—Ä –¥–ª—è –≤—ã–¥–µ–ª–µ–Ω–∏—è –§–ò–û –∏–∑ —Ç–µ–∫—Å—Ç–∞"""
    
    # –°–ø–∏—Å–∫–∏ —Å—Ç–æ–ø-—Å–ª–æ–≤ —Ä–∞–∑–Ω–æ–≥–æ —É—Ä–æ–≤–Ω—è
    STOP_WORDS = {
        # –û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏, –¥–æ–ª–∂–Ω–æ—Å—Ç–∏
        "—É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç", "–≥–æ—Å—É–¥–∞—Ä—Å—Ç–≤–µ–Ω–Ω—ã–π" 
        "—Å—Ç—É–¥–µ–Ω—Ç", "—É—á–∞—Å—Ç–Ω–∏–∫", "—Å–æ—Ç—Ä—É–¥–Ω–∏–∫", "—É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ",
        
        # –ü—Ä–µ–¥–ª–æ–≥–∏, —Å–æ—é–∑—ã
        "–Ω–∞", "–ø–æ", "–≤", "–∏–∑", "–æ—Ç", "–¥–æ", "–∑–∞", "—Å", "–∫", "—É",
        "–∏", "–∏–ª–∏", "–Ω–æ", "–∞", "–∂–µ",
        
        # –ú—É—Å–æ—Ä–Ω—ã–µ —Å–ª–æ–≤–∞
        "–Ω–æ–º–µ—Ä", "–ø—Ä–æ–ø—É—Å–∫", "–∫–∞—Ä—Ç–∞", "—Ñ–æ—Ç–æ", "–¥–∞—Ç–∞", "–≤—ã–¥–∞—á–∞",
        "–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω", "–ø–æ–¥–ø–∏—Å—å", "–ø–µ—á–∞—Ç—å", "–æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è",
        
        # –ö–æ—Ä–æ—Ç–∫–∏–π –º—É—Å–æ—Ä
        "–∞–æ", "–æ–æ", "–∑–∞–æ", "–ø–∞–æ", "–Ω–∫–æ", "–∏–ø",
    }
    
    # –ü–∞—Ç—Ç–µ—Ä–Ω—ã –¥–ª—è –§–ò–û
    NAME_PATTERNS = [
        r'^[–ê-–Ø–Å][–∞-—è—ë]{1,20}$',  # –û–¥–Ω–æ —Å–ª–æ–≤–æ —Å –∑–∞–≥–ª–∞–≤–Ω–æ–π
        r'^[–ê-–Ø–Å][–∞-—è—ë]+[- ][–ê-–Ø–Å][–∞-—è—ë]+$',  # –î–≤–æ–π–Ω—ã–µ –∏–º–µ–Ω–∞/—Ñ–∞–º–∏–ª–∏–∏
    ]
    
    # –¢–∏–ø–∏—á–Ω—ã–µ –∏–º–µ–Ω–∞ –∏ —Ñ–∞–º–∏–ª–∏–∏ (–¥–ª—è –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞)
    COMMON_FIRST_NAMES = {
        "–∞–Ω–¥—Ä–µ–π", "–∞–ª–µ–∫—Å–µ–π", "–∞–ª–µ–∫—Å–∞–Ω–¥—Ä", "–∞—Ä—Ç–µ–º", "–∞—Ä—Ç—ë–º", "–±–æ—Ä–∏—Å", "–≤–∞–¥–∏–º",
        "–≤–∞–ª–µ–Ω—Ç–∏–Ω", "–≤–∞–ª–µ—Ä–∏–π", "–≤–∞—Å–∏–ª–∏–π", "–≤–∏–∫—Ç–æ—Ä", "–≤–ª–∞–¥–∏–º–∏—Ä", "–≤–ª–∞–¥–∏—Å–ª–∞–≤",
        "–≥–µ–Ω–Ω–∞–¥–∏–π", "–≥–µ–æ—Ä–≥–∏–π", "–≥—Ä–∏–≥–æ—Ä–∏–π", "–¥–∞–Ω–∏–∏–ª", "–¥–µ–Ω–∏—Å", "–¥–º–∏—Ç—Ä–∏–π",
        "–µ–≤–≥–µ–Ω–∏–π", "–µ–≥–æ—Ä", "–∏–≤–∞–Ω", "–∏–≥–æ—Ä—å", "–∫–∏—Ä–∏–ª–ª", "–∫–æ–Ω—Å—Ç–∞–Ω—Ç–∏–Ω",
        "–ª–µ–≤", "–ª–µ–æ–Ω–∏–¥", "–º–∞–∫—Å–∏–º", "–º–∏—Ö–∞–∏–ª", "–Ω–∏–∫–æ–ª–∞–π", "–æ–ª–µ–≥",
        "–ø–∞–≤–µ–ª", "–ø–µ—Ç—Ä", "–ø—ë—Ç—Ä", "—Ä–æ–º–∞–Ω", "—Ä—É—Å–ª–∞–Ω", "—Å–µ—Ä–≥–µ–π",
        "—Å—Ç–∞–Ω–∏—Å–ª–∞–≤", "—Å—Ç–µ–ø–∞–Ω", "—Ç–∏–º–æ—Ñ–µ–π", "—Ñ–µ–¥–æ—Ä", "—Ñ—ë–¥–æ—Ä", "—é—Ä–∏–π",
        "—è—Ä–æ—Å–ª–∞–≤",
        
        "–∞–ª–µ–Ω–∞", "–∞–ª—ë–Ω–∞", "–∞–ª–∏–Ω–∞", "–∞–ª–ª–∞", "–∞–Ω–∞—Å—Ç–∞—Å–∏—è", "–∞–Ω–≥–µ–ª–∏–Ω–∞",
        "–∞–Ω–Ω–∞", "–∞–Ω—Ç–æ–Ω–∏–Ω–∞", "–≤–∞–ª–µ–Ω—Ç–∏–Ω–∞", "–≤–∞–ª–µ—Ä–∏—è", "–≤–µ—Ä–∞", "–≤–∏–∫—Ç–æ—Ä–∏—è",
        "–≥–∞–ª–∏–Ω–∞", "–¥–∞—Ä—å—è", "–¥–∏–∞–Ω–∞", "–µ–≤–≥–µ–Ω–∏—è", "–µ–∫–∞—Ç–µ—Ä–∏–Ω–∞", "–µ–ª–µ–Ω–∞",
        "–µ–ª–∏–∑–∞–≤–µ—Ç–∞", "–∂–∏–Ω–∞—Ä", "–∑–∏–Ω–∞–∏–¥–∞", "–∏–Ω–Ω–∞", "–∏—Ä–∏–Ω–∞", "–∫—Ä–∏—Å—Ç–∏–Ω–∞",
        "–∫—Å–µ–Ω–∏—è", "–∫—Å—ë–Ω–∏—è", "–ª–∞—Ä–∏—Å–∞", "–ª—é–±–æ–≤—å", "–ª—é–¥–º–∏–ª–∞", "–º–∞—Ä–∏–Ω–∞",
        "–º–∞—Ä–∏—è", "–º–∞—Ä–≥–∞—Ä–∏—Ç–∞", "–Ω–∞–¥–µ–∂–¥–∞", "–Ω–∞—Ç–∞–ª—å—è", "–Ω–∞—Ç–∞–ª–∏—è", "–æ–∫—Å–∞–Ω–∞",
        "–æ–ª—å–≥–∞", "–ø–æ–ª–∏–Ω–∞", "—Å–≤–µ—Ç–ª–∞–Ω–∞", "—Å–æ—Ñ–∏—è", "—Å–æ—Ñ—å—è", "—Ç–∞–º–∞—Ä–∞",
        "—Ç–∞—Ç—å—è–Ω–∞", "—é–ª–∏—è", "—è–Ω–∞",
    }
    
    COMMON_LAST_NAMES = {
        "–∏–≤–∞–Ω–æ–≤", "–ø–µ—Ç—Ä–æ–≤", "—Å–∏–¥–æ—Ä–æ–≤", "—Å–º–∏—Ä–Ω–æ–≤", "–∫—É–∑–Ω–µ—Ü–æ–≤", "–ø–æ–ø–æ–≤",
        "–≤–∞—Å–∏–ª—å–µ–≤", "–º–∏—Ö–∞–π–ª–æ–≤", "–Ω–æ–≤–∏–∫–æ–≤", "—Ñ–µ–¥–æ—Ä–æ–≤", "–º–æ—Ä–æ–∑–æ–≤", "–≤–æ–ª–∫–æ–≤",
        "–∞–ª–µ–∫—Å–µ–µ–≤", "–ª–µ–±–µ–¥–µ–≤", "—Å–µ–º–µ–Ω–æ–≤", "–µ–≥–æ—Ä–æ–≤", "–ø–∞–≤–ª–æ–≤", "–∫–æ–∑–ª–æ–≤",
        "—Å—Ç–µ–ø–∞–Ω–æ–≤", "–Ω–∏–∫–∏—Ç–∏–Ω", "–æ—Ä–ª–æ–≤", "–∞–Ω–¥—Ä–µ–µ–≤", "–º–∞–∫–∞—Ä–æ–≤", "–Ω–∏–∫–∏—Ç–∏–Ω",
        "–∑–∞—Ö–∞—Ä–æ–≤", "–∑–∞–π—Ü–µ–≤", "—Å–æ–ª–æ–≤—å–µ–≤", "–±–æ—Ä–∏—Å–æ–≤", "—è–∫–æ–≤–ª–µ–≤", "–≥—Ä–∏–≥–æ—Ä—å–µ–≤",
        "—Ä–æ–º–∞–Ω–æ–≤", "–≤–æ—Ä–æ–Ω–∏–Ω", "–≥—É—Å–µ–≤", "—Ç–∏—Ç–æ–≤", "–∫—É–∑—å–º–∏–Ω", "–∫—Ä—ã–ª–æ–≤",
        "—Ç–∏—Ö–æ–Ω–æ–≤", "–∫–æ–º–∞—Ä–æ–≤", "–º–∞–∫—Å–∏–º–æ–≤", "–±–µ–ª–æ–≤", "—à—É–±–∏–Ω", "–∫–æ–Ω–¥—Ä–∞—Ç—å–µ–≤",
        "–∏–ª—å–∏–Ω", "—Ñ–∏–ª–∏–ø–ø–æ–≤", "–ø–æ–Ω–æ–º–∞—Ä–µ–≤", "–º–∞–º–æ–Ω—Ç–æ–≤", "–Ω–æ—Å–æ–≤", "–≥–æ–ª—É–±–µ–≤",
        "–∫–∞—Ä–ø–æ–≤", "–∞—Ñ–∞–Ω–∞—Å—å–µ–≤", "–≤–ª–∞–¥–∏–º–∏—Ä–æ–≤", "–º–µ–ª—å–Ω–∏–∫–æ–≤", "–¥–µ–Ω–∏—Å–æ–≤",
        "–≥—Ä–æ–º–æ–≤", "—Ñ–æ–º–∏–Ω", "–¥–∞–≤—ã–¥–æ–≤", "–±–µ–ª—è–µ–≤", "—Ç—Ä–µ—Ç—å—è–∫–æ–≤", "—Å–∞–≤–µ–ª—å–µ–≤",
        "–ø–∞–Ω–æ–≤", "—Ä—ã–±–∞–∫–æ–≤", "—Å—É—Ö–∞–Ω–æ–≤", "–∞–±–¥—É–ª–ª–∏–Ω", "–∞–≥–∞—Ñ–æ–Ω–æ–≤", "–∞–Ω–∏—Å–∏–º–æ–≤",
        "–∞—Ä—Ç–µ–º—å–µ–≤", "–∞—Ä—Ö–∏–ø–æ–≤", "–∞—Å—Ç–∞—Ñ—å–µ–≤", "–±–∞—Ä–∞–Ω–æ–≤", "–±–µ–ª–æ—É—Å–æ–≤",
        "–±–æ–≥–¥–∞–Ω–æ–≤", "–±–æ–ª—å—à–∞–∫–æ–≤", "–±–æ–Ω–¥–∞—Ä–µ–≤", "–±—ã–∫–æ–≤", "–≤–∞—Å–∏–ª—å–µ–≤",
        "–≤–µ—Å–µ–ª–æ–≤", "–≤–∏–Ω–æ–≥—Ä–∞–¥–æ–≤", "–≤–ª–∞—Å–æ–≤", "–≤–ª–∞–¥–∏–º–∏—Ä–æ–≤", "–≤–æ—Ä–æ–±—å–µ–≤",
        "–≥–∞–≤—Ä–∏–ª–æ–≤", "–≥—Ä–∏—à–∏–Ω", "–¥–∞–Ω–∏–ª–æ–≤", "–¥–µ–º–µ–Ω—Ç—å–µ–≤", "–¥–æ—Ä–æ—Ñ–µ–µ–≤",
        "–µ—Ñ–∏–º–æ–≤", "–∂–∏–¥–æ–≤", "–∂—É–∫–æ–≤", "–∑–∞–π—Ü–µ–≤", "–∑–∏–Ω–æ–≤—å–µ–≤", "–∑–∏–º–∏–Ω",
        "–∑–Ω–∞–º–µ–Ω—Å–∫–∏–π", "–∑—É–µ–≤", "–∏–≥–Ω–∞—Ç–æ–≤", "–∏–≥–Ω–∞—Ç—å–µ–≤", "–∫–∞–ª–∞—à–Ω–∏–∫–æ–≤",
        "–∫–∞–ø—É—Å—Ç–∏–Ω", "–∫–∏—Ä–∏–ª–ª–æ–≤", "–∫–∏—Å–µ–ª–µ–≤", "–∫–ª–∏–º–æ–≤", "–∫–Ω—è–∑–µ–≤", "–∫–æ–≤—Ä–æ–≤",
        "–∫–æ–∂–µ–≤–Ω–∏–∫–æ–≤", "–∫–æ–∑–ª–æ–≤", "–∫–æ–ª–æ–±–æ–≤", "–∫–æ–º–∏—Å—Å–∞—Ä–æ–≤", "–∫–æ—Ä–æ–ª–µ–≤",
        "–∫–æ—Å—Ç—Ä–æ–º–∏–Ω", "–∫—Ä–∞—Å–∏–ª—å–Ω–∏–∫–æ–≤", "–∫—Ä–∞—Å–æ–≤", "–∫—Ä—É–≥–ª–æ–≤", "–∫—Ä—ã–ª–æ–≤",
        "–∫—É–¥—Ä—è–≤—Ü–µ–≤", "–∫—É–ª–∞–∫–æ–≤", "–ª–∞–ø–∏–Ω", "–ª–∞—Ä–∏–Ω", "–ª–µ–æ–Ω–æ–≤", "–ª–∏—Ö–∞—á–µ–≤",
        "–ª—É–∫–∏–Ω", "–ª—ã–∫–æ–≤", "–º–∞–π–æ—Ä–æ–≤", "–º–∞–ª—å—Ü–µ–≤", "–º–∞—Ä—É—Å–∏–Ω", "–º–∞—Å–ª–µ–Ω–Ω–∏–∫–æ–≤",
        "–º–µ–¥–≤–µ–¥–µ–≤", "–º–∏—Ä–æ–Ω–æ–≤", "–º–∏—à–∏–Ω", "–º–æ–ª—á–∞–Ω–æ–≤", "–º—É—Ä–∞–≤—å–µ–≤", "–º—É—Ö–∏–Ω",
        "–Ω–∞–∑–∞—Ä–æ–≤", "–Ω–∞—É–º–æ–≤", "–Ω–µ—Å—Ç–µ—Ä–æ–≤", "–Ω–µ—Ñ–µ–¥–æ–≤", "–Ω–µ—á–∞–µ–≤", "–æ–±—É—Ö–æ–≤",
        "–æ–≤—á–∏–Ω–Ω–∏–∫–æ–≤", "–æ–∑–µ—Ä–æ–≤", "–æ–∫–ª–∞–¥–Ω–∏–∫–æ–≤", "–æ—Å–∏–Ω", "–æ—Å–∏–ø–æ–≤",
        "–æ—Å—Ç—Ä–æ–≤—Å–∫–∏–π", "–ø–∞–≤–ª–æ–≤—Å–∫–∏–π", "–ø–∞–Ω–∫—Ä–∞—Ç–æ–≤", "–ø–∞–Ω—Ç–µ–ª–µ–µ–≤", "–ø–∞—Å—Ç—É—Ö–æ–≤",
        "–ø–µ—Å—Ç–æ–≤", "–ø–µ—Ç—Ä—É—Ö–∏–Ω", "–ø–µ—Ç—É—Ö–æ–≤", "–ø–∏–º–µ–Ω–æ–≤", "–ø–ª–∞—Ç–æ–Ω–æ–≤", "–ø–æ–∑–¥–Ω—è–∫–æ–≤",
        "–ø–æ–∫—Ä–æ–≤—Å–∫–∏–π", "–ø–æ–ª—è–∫–æ–≤", "–ø–æ–ø–æ–≤", "–ø—Ä–æ–∫–æ—Ñ—å–µ–≤", "–ø—Ä–æ—Ö–æ—Ä–æ–≤",
        "–ø—É–≥–∞—á–µ–≤", "—Ä–∞–∑–∏–Ω", "—Ä–æ–≥–æ–≤", "—Ä–æ–º–∞–Ω–æ–≤", "—Ä—É—Å–∞–∫–æ–≤", "—Ä—ã–∂–æ–≤",
        "—Å–∞–≤–∏–Ω", "—Å–∞–≤–∏—Ü–∫–∏–π", "—Å–∞–ª—Ç—ã–∫–æ–≤", "—Å–∞–º–æ–π–ª–æ–≤", "—Å–∞—Ñ–æ–Ω–æ–≤", "—Å–µ–ª–µ–∑–Ω–µ–≤",
        "—Å–µ–º–µ–Ω–æ–≤", "—Å–∏–ª–∞–Ω—Ç—å–µ–≤", "—Å–∏–Ω–∏—Ü—ã–Ω", "—Å–∫–∞—Ç–æ–≤", "—Å–æ–±–æ–ª–µ–≤", "—Å–æ–∫–æ–ª–æ–≤",
        "—Å–æ–ª–æ–≤—å–µ–≤", "—Å–æ—Ñ—Ä–æ–Ω–æ–≤", "—Å–ø–∏—Ä–∏–Ω", "—Å—Ç–∞—Ä–æ—Å—Ç–∏–Ω", "—Å—Ç–µ–ø–∞–Ω–æ–≤",
        "—Å—Ç—Ä–∞—Ö–æ–≤", "—Å—É–¥–∞–∫–æ–≤", "—Å—É—Ä–∏–∫–æ–≤", "—Å—ã—Å–æ–µ–≤", "—Ç–∞—Ä–∞—Å–æ–≤", "—Ç–µ—Ä–µ–Ω—Ç—å–µ–≤",
        "—Ç–∏–º–æ—Ñ–µ–µ–≤", "—Ç–∏—Ö–æ–º–∏—Ä–æ–≤", "—Ç–∏—Ö–æ–Ω–æ–≤", "—Ç–æ–∫–∞—Ä–µ–≤", "—Ç–æ–ª–º–∞—á–µ–≤",
        "—Ç—Ä–µ—Ç—å—è–∫–æ–≤", "—Ç—Ä–æ—Ñ–∏–º–æ–≤", "—Ç—É—Ä–æ–≤", "—É–≤–∞—Ä–æ–≤", "—É–ª—å—è–Ω–æ–≤", "—É—Å—Ç–∏–Ω–æ–≤",
        "—Ñ–∞–¥–µ–µ–≤", "—Ñ–µ–¥–æ—Å–µ–µ–≤", "—Ñ–∏–ª–∞—Ç–æ–≤", "—Ñ–∏–ª–∏–ø–ø–æ–≤", "—Ñ–æ–∫–∏–Ω", "—Ñ—Ä–æ–ª–æ–≤",
        "—Ö–∞—Ä–∏—Ç–æ–Ω–æ–≤", "—Ö—Ä–æ–º–æ–≤", "—Ü–∞—Ä–µ–≤", "—Ü—ã–≥–∞–Ω–∫–æ–≤", "—á–∞–¥–æ–≤", "—á–µ—Ä–µ–ø–∞–Ω–æ–≤",
        "—á–µ—Ä–∫–∞—Å–æ–≤", "—á–µ—Ä–Ω–æ–≤", "—á–µ—Ä–Ω—ã—à–µ–≤", "—á—É–π–∫–æ–≤", "—à–∞–±–∞–Ω–æ–≤", "—à–∞–ª–∞–µ–≤",
        "—à–∞–ø–æ—à–Ω–∏–∫–æ–≤", "—à–∞—Ä–æ–≤", "—à–≤–µ—Ü–æ–≤", "—à–µ—Å—Ç–∞–∫–æ–≤", "—à–∏–ª–æ–≤", "—à–∏–ø–∏—Ü—ã–Ω",
        "—à–∏—Ä–æ–∫–æ–≤", "—à–∏—Ä—è–µ–≤", "—à–º–µ–ª–µ–≤", "—à—É–±–∏–Ω", "—à—É–≤–∞–ª–æ–≤", "—â–µ–≥–ª–æ–≤",
        "—â–µ–ø–∫–∏–Ω", "—â—É–∫–∏–Ω", "—é–¥–∏–Ω", "—é–º–∞—à–µ–≤", "—é—Ä–æ–≤", "—é—Ä—å–µ–≤", "—è–∫–æ–≤–ª–µ–≤",
        "—è–∫—É—à–µ–≤", "—è—à–∏–Ω",
    }
    
    @staticmethod
    def is_stop_word(word):
        """–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å—Ç–æ–ø-—Å–ª–æ–≤–æ"""
        word_lower = word.lower()
        
        # –°–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–µ
        if len(word) < 2:
            return True
        
        # –ß–∏—Å–ª–∞
        if re.match(r'^\d+$', word):
            return True
        
        # –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã
        if re.match(r'^[^–∞-—è–ê-–Ø—ë–Å]+$', word):
            return True
        
        # –°—Ç–æ–ø-—Å–ª–æ–≤–∞ –∏–∑ —Å–ø–∏—Å–∫–∞
        if word_lower in NameFilter.STOP_WORDS:
            return True
        
        # –°–ª–æ–≤–∞ –≤ –≤–µ—Ä—Ö–Ω–µ–º —Ä–µ–≥–∏—Å—Ç—Ä–µ (—á–∞—Å—Ç–æ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏)
        if word.isupper() and len(word) > 3:
            return True
        
        # –ü–∞—Ç—Ç–µ—Ä–Ω—ã –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–π
        org_patterns = [r'.*—É–Ω–∏–≤–µ—Ä.*']
        for pattern in org_patterns:
            if re.match(pattern, word_lower):
                return True
        
        return False
    
    @staticmethod
    def is_likely_name_part(word):
        """–ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ —Å–ª–æ–≤–æ –ø–æ—Ö–æ–∂–µ –Ω–∞ —á–∞—Å—Ç—å –∏–º–µ–Ω–∏"""
        if NameFilter.is_stop_word(word):
            return False
        
        word_lower = word.lower()
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–∞—Ç—Ç–µ—Ä–Ω—ã –§–ò–û
        for pattern in NameFilter.NAME_PATTERNS:
            if re.match(pattern, word):
                return True
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ —Å–ø–∏—Å–∫–∞–º —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω—ë–Ω–Ω—ã—Ö –∏–º—ë–Ω/—Ñ–∞–º–∏–ª–∏–π
        if (word_lower in NameFilter.COMMON_FIRST_NAMES or 
            word_lower in NameFilter.COMMON_LAST_NAMES):
            return True
        
        # –≠–≤—Ä–∏—Å—Ç–∏–∫–∏ –¥–ª—è –∏–º—ë–Ω
        if (word[0].isupper() and 
            len(word) >= 3 and 
            word.isalpha() and
            not any(ch.isdigit() for ch in word)):
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–∫–æ–Ω—á–∞–Ω–∏—è
            common_endings = ['–æ–≤', '–µ–≤', '–∏–Ω', '—ã–Ω', '–æ–≤–∞', '–µ–≤–∞', '–∏–Ω–∞', '—ã–Ω–∞',
                             '–∏–π', '–æ–π', '–∞—è', '—è—è', '–ª—å', '–¥—Ä–∞', '–ª–∞', '—Ç–∞']
            for ending in common_endings:
                if word_lower.endswith(ending):
                    return True
        
        return False
    
    @staticmethod
    def extract_fio_from_lines(lines):
        """–ò–∑–≤–ª–µ–∫–∞–µ—Ç –§–ò–û –∏–∑ —Å–ø–∏—Å–∫–∞ —Å—Ç—Ä–æ–∫"""
        all_words = []
        for line in lines:
            words = re.split(r'[\s,.;:]+', line.strip())
            all_words.extend(words)
        
        # –§–∏–ª—å—Ç—Ä—É–µ–º –∏ —Å–æ–±–∏—Ä–∞–µ–º –∫–∞–Ω–¥–∏–¥–∞—Ç—ã
        candidates = []
        for word in all_words:
            if NameFilter.is_likely_name_part(word):
                candidates.append(word)
        
        # –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ —Å—Ö–æ–¥—Å—Ç–≤—É
        if len(candidates) >= 2:
            # –ü—Ä–æ–±—É–µ–º —Å–æ–±—Ä–∞—Ç—å –≤ –ø–æ—Ä—è–¥–∫–µ: –§–∞–º–∏–ª–∏—è –ò–º—è –û—Ç—á–µ—Å—Ç–≤–æ
            fio_parts = []
            for candidate in candidates:
                if candidate not in fio_parts:
                    fio_parts.append(candidate)
            
            # –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º —Ç—Ä–µ–º—è —á–∞—Å—Ç—è–º–∏
            fio = " ".join(fio_parts[:3])
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –µ—Å—Ç—å —Ö–æ—Ç—è –±—ã 2 —á–∞—Å—Ç–∏
            if len(fio_parts) >= 2:
                return fio
        
        return None

# === –£–õ–£–ß–®–ï–ù–ù–ê–Ø –û–ë–†–ê–ë–û–¢–ö–ê ===
def preprocess_for_ocr(image):
    """–ü—Ä–µ–¥–æ–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è OCR"""
    if len(image.shape) == 3:
        gray = cv2.cvtColor(image, cv2.COLOR_BGR2GRAY)
    else:
        gray = image
    
    # –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –∫–æ–Ω—Ç—Ä–∞—Å—Ç
    clahe = cv2.createCLAHE(clipLimit=2.0, tileGridSize=(8, 8))
    enhanced = clahe.apply(gray)
    
    # –£–º–µ–Ω—å—à–∞–µ–º —à—É–º
    denoised = cv2.bilateralFilter(enhanced, 9, 75, 75)
    
    # –ü–æ—Ä–æ–≥–æ–≤–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
    _, binary = cv2.threshold(denoised, 0, 255, cv2.THRESH_BINARY + cv2.THRESH_OTSU)
    
    # –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –¥–ª—è –ª—É—á—à–µ–≥–æ —á—Ç–µ–Ω–∏—è
    scale = 2
    new_size = (binary.shape[1] * scale, binary.shape[0] * scale)
    resized = cv2.resize(binary, new_size, interpolation=cv2.INTER_CUBIC)
    
    return resized

def extract_text_with_context(card_image):
    """–ò–∑–≤–ª–µ–∫–∞–µ—Ç —Ç–µ–∫—Å—Ç —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º –∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π"""
    # –ü—Ä–µ–¥–æ–±—Ä–∞–±–æ—Ç–∫–∞
    processed = preprocess_for_ocr(card_image)
    
    # OCR —Å —Ä–∞–∑–Ω—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
    try:
        # –ü—Ä–æ–±—É–µ–º –ø–æ–¥—Ä–æ–±–Ω—ã–π OCR
        detailed_results = reader.readtext(
            processed, 
            detail=1,
            paragraph=False,
            width_ths=0.7,
            ycenter_ths=0.5
        )
        
        # –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ —Ç–µ–∫—Å—Ç—ã
        all_texts = []
        for bbox, text, confidence in detailed_results:
            if confidence > 0.1:  # –ù–∏–∑–∫–∏–π –ø–æ—Ä–æ–≥
                all_texts.append(text.strip())
        
        # –ü—Ä–æ–±—É–µ–º —É–º–Ω—É—é —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é
        filter = NameFilter()
        fio = filter.extract_fio_from_lines(all_texts)
        
        if fio:
            return fio, all_texts
        
        # –ï—Å–ª–∏ —É–º–Ω–∞—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª–∞, –ø—Ä–æ–±—É–µ–º –ø—Ä–æ—Å—Ç—É—é —ç–≤—Ä–∏—Å—Ç–∏–∫—É
        if all_texts:
            # –ò—â–µ–º —Å—Ç—Ä–æ–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ –≤—ã–≥–ª—è–¥—è—Ç –∫–∞–∫ –∏–º–µ–Ω–∞
            likely_names = []
            for text in all_texts:
                words = text.split()
                name_words = [w for w in words if filter.is_likely_name_part(w)]
                if name_words:
                    likely_names.extend(name_words)
            
            if len(likely_names) >= 2:
                return " ".join(likely_names[:3]), all_texts
        
        return None, all_texts
        
    except Exception as e:
        st.warning(f"–û—à–∏–±–∫–∞ OCR: {e}")
        return None, []

# === –û–°–ù–û–í–ù–ê–Ø –û–ë–†–ê–ë–û–¢–ö–ê ===
def process_single_image(image, filename, show_debug=True):
    """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –æ–¥–Ω–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ"""
    results = []
    debug_info = {}
    
    if show_debug:
        st.subheader(f"üì∑ –û–±—Ä–∞–±–æ—Ç–∫–∞: {filename}")
        col1, col2 = st.columns(2)
        
        with col1:
            st.image(image, caption=f"–ò—Å—Ö–æ–¥–Ω–æ–µ", use_container_width=True)
    
    # –î–µ—Ç–µ–∫—Ü–∏—è –ø—Ä–æ–ø—É—Å–∫–æ–≤
    yolo_results = model(image, conf=0.2, verbose=False)
    
    if show_debug:
        with col2:
            if hasattr(yolo_results[0], 'plot'):
                plotted = yolo_results[0].plot()
                st.image(plotted, caption="–î–µ—Ç–µ–∫—Ü–∏–∏ YOLO", use_container_width=True)
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–π–¥–µ–Ω–Ω—ã–µ –ø—Ä–æ–ø—É—Å–∫–∏
    if yolo_results[0].boxes is not None:
        cards_found = len(yolo_results[0].boxes)
        debug_info['cards_detected'] = cards_found
        
        if show_debug:
            st.info(f"‚úÖ –ù–∞–π–¥–µ–Ω–æ –ø—Ä–æ–ø—É—Å–∫–æ–≤: {cards_found}")
        
        # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–∞–∂–¥—ã–π –ø—Ä–æ–ø—É—Å–∫
        for i, box in enumerate(yolo_results[0].boxes):
            x1, y1, x2, y2 = map(int, box.xyxy[0])
            card = image[y1:y2, x1:x2]
            
            if show_debug:
                with st.expander(f"–ü—Ä–æ–ø—É—Å–∫ {i+1} (—Ä–∞–∑–º–µ—Ä: {card.shape[1]}x{card.shape[0]})"):
                    st.image(card, caption=f"–í—ã—Ä–µ–∑–∞–Ω–Ω—ã–π –ø—Ä–æ–ø—É—Å–∫", use_container_width=True)
            
            # –ò–∑–≤–ª–µ–∫–∞–µ–º —Ç–µ–∫—Å—Ç
            fio, all_texts = extract_text_with_context(card)
            
            if show_debug:
                if all_texts:
                    st.write("**–í–µ—Å—å –Ω–∞–π–¥–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç:**")
                    for text in all_texts:
                        st.write(f"  - `{text}`")
            
            if fio:
                results.append(fio)
                if show_debug:
                    st.success(f"‚úÖ –ù–∞–π–¥–µ–Ω –§–ò–û: **{fio}**")
            elif show_debug:
                st.warning("–§–ò–û –Ω–µ –Ω–∞–π–¥–µ–Ω–æ")
    
    else:
        debug_info['cards_detected'] = 0
        if show_debug:
            st.warning("‚ùå –ü—Ä–æ–ø—É—Å–∫–∏ –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω—ã")
    
    return results, debug_info

# === –ò–ù–¢–ï–†–§–ï–ô–° STREAMLIT ===
st.sidebar.header("‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏")
debug_mode = st.sidebar.checkbox("–ü–æ–∫–∞–∑–∞—Ç—å –æ—Ç–ª–∞–¥–∫—É", True)
conf_threshold = st.sidebar.slider("–ü–æ—Ä–æ–≥ —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏ YOLO", 0.1, 0.9, 0.2, 0.05)

uploaded_files = st.file_uploader(
    "üì∑ –ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–æ—Ç–æ —Å –ø—Ä–æ–ø—É—Å–∫–∞–º–∏",
    type=["jpg", "jpeg", "png"],
    accept_multiple_files=True,
    help="–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –∑–∞–≥—Ä—É–∂–∞—Ç—å —á—ë—Ç–∫–∏–µ —Ñ–æ—Ç–æ"
)

if uploaded_files:
    all_fios = []
    total_cards = 0
    
    progress_bar = st.progress(0)
    status_text = st.empty()
    
    for idx, uploaded_file in enumerate(uploaded_files):
        status_text.text(f"–û–±—Ä–∞–±–æ—Ç–∫–∞ {idx+1}/{len(uploaded_files)}")
        
        # –ß–∏—Ç–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
        file_bytes = uploaded_file.getvalue()
        nparr = np.frombuffer(file_bytes, np.uint8)
        img = cv2.imdecode(nparr, cv2.IMREAD_COLOR)
        
        if img is None:
            st.error(f"–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å: {uploaded_file.name}")
            continue
        
        # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º
        fios, debug = process_single_image(img, uploaded_file.name, debug_mode)
        all_fios.extend(fios)
        total_cards += debug.get('cards_detected', 0)
        
        progress_bar.progress((idx + 1) / len(uploaded_files))
    
    status_text.empty()
    progress_bar.empty()
    
    # === –í–´–í–û–î –†–ï–ó–£–õ–¨–¢–ê–¢–û–í ===
    st.markdown("---")
    st.subheader("üìã –†–µ–∑—É–ª—å—Ç–∞—Ç—ã")
    
    if all_fios:
        # –£–±–∏—Ä–∞–µ–º –¥—É–±–ª–∏–∫–∞—Ç—ã, —Å–æ—Ö—Ä–∞–Ω—è—è –ø–æ—Ä—è–¥–æ–∫
        unique_fios = []
        seen = set()
        for fio in all_fios:
            if fio not in seen:
                seen.add(fio)
                unique_fios.append(fio)
        
        st.success(f"‚úÖ –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ {len(uploaded_files)} —Ñ–∞–π–ª–æ–≤")
        st.metric("–ù–∞–π–¥–µ–Ω–æ –§–ò–û", len(unique_fios))
        st.metric("–û–±–Ω–∞—Ä—É–∂–µ–Ω–æ –ø—Ä–æ–ø—É—Å–∫–æ–≤", total_cards)
        
        # –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –∞–ª—Ñ–∞–≤–∏—Ç—É
        final_fios = sorted(unique_fios, key=lambda x: x.split()[0] if x.split() else x)
        
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ø–∏—Å–æ–∫
        st.write("**‚úèÔ∏è –û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ —Å–ø–∏—Å–æ–∫ (–Ω–∞–∂–º–∏—Ç–µ –≤ —è—á–µ–π–∫—É ‚Üí –∏–∑–º–µ–Ω–∏—Ç–µ ‚Üí Enter):**")
        df_editable = pd.DataFrame(final_fios, columns=["–§–ò–û"])
        edited_df = st.data_editor(
            df_editable,
            num_rows="dynamic",
            column_config={"–§–ò–û": {"width": "medium"}},
            use_container_width=True,
            key="fio_editor"
        )

        # –§–∏–Ω–∞–ª—å–Ω—ã–π —Å–ø–∏—Å–æ–∫ ‚Äî —Ç–æ–ª—å–∫–æ –Ω–µ–ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏
        final_fios = edited_df["–§–ò–û"].dropna().astype(str).str.strip()
        final_fios = final_fios[final_fios != ""].tolist()

        if final_fios != final_fios:
            st.info(f"‚úÖ –ò–∑–º–µ–Ω–µ–Ω–æ: –±—ã–ª–æ {len(final_fios)}, —Å—Ç–∞–ª–æ {len(final_fios)}")
        
        # –≠–∫—Å–ø–æ—Ä—Ç
        col1, col2, col3 = st.columns(3)
        
        with col1:
            # Excel
            excel_buffer = tempfile.NamedTemporaryFile(suffix='.xlsx', delete=False)
            df.to_excel(excel_buffer.name, index=False)
            with open(excel_buffer.name, 'rb') as f:
                st.download_button(
                    "üìä Excel",
                    f.read(),
                    "—Å–ø–∏—Å–æ–∫_—É—á–∞—Å—Ç–Ω–∏–∫–æ–≤.xlsx",
                    "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
                )
        
        with col2:
            # CSV
            csv_data = df.to_csv(index=False).encode('utf-8-sig')
            st.download_button(
                "üìÑ CSV",
                csv_data,
                "—Å–ø–∏—Å–æ–∫_—É—á–∞—Å—Ç–Ω–∏–∫–æ–≤.csv",
                "text/csv"
            )
        
        with col3:
            # –¢–µ–∫—Å—Ç
            text_data = "\n".join(final_fios)
            st.download_button(
                "üìù TXT",
                text_data,
                "—Å–ø–∏—Å–æ–∫_—É—á–∞—Å—Ç–Ω–∏–∫–æ–≤.txt",
                "text/plain"
            )
    
    else:
        st.error("‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω–æ –Ω–∏ –æ–¥–Ω–æ–≥–æ –§–ò–û")
        
        if total_cards > 0:
            st.warning(f"–û–±–Ω–∞—Ä—É–∂–µ–Ω–æ {total_cards} –ø—Ä–æ–ø—É—Å–∫–æ–≤, –Ω–æ –Ω–µ —É–¥–∞–ª–æ—Å—å –∏–∑–≤–ª–µ—á—å –§–ò–û")
            st.info("""
            **–í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:**
            1. –¢–µ–∫—Å—Ç –Ω–∞ –ø—Ä–æ–ø—É—Å–∫–∞—Ö –Ω–µ—á–∏—Ç–∞–µ–º
            2. –ù—É–∂–Ω–∞ –ª—É—á—à–∞—è –ø—Ä–µ–¥–æ–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
            3. –í–æ–∑–º–æ–∂–Ω–æ, –§–ò–û –∑–∞–ø–∏—Å–∞–Ω–æ –≤ –Ω–µ—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ
            """)
        else:
            st.warning("""
            **–ü—Ä–æ–ø—É—Å–∫–∏ –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω—ã. –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:**
            1. –ú–æ–¥–µ–ª—å –Ω–µ –æ–±—É—á–µ–Ω–∞ –Ω–∞ —Ç–∞–∫–∏—Ö —Ç–∏–ø–∞—Ö –ø—Ä–æ–ø—É—Å–∫–æ–≤
            2. –§–æ—Ç–æ —Å–ª–∏—à–∫–æ–º —Ç—ë–º–Ω–æ–µ/—Å–≤–µ—Ç–ª–æ–µ
            3. –ü—Ä–æ–ø—É—Å–∫–∞ —Å–ª–∏—à–∫–æ–º –º–µ–ª–∫–∏–µ –Ω–∞ —Ñ–æ—Ç–æ
            """)

# === –ò–ù–§–û–†–ú–ê–¶–ò–Ø –û –°–ò–°–¢–ï–ú–ï ===
with st.sidebar.expander("‚ÑπÔ∏è –û —Å–∏—Å—Ç–µ–º–µ"):
    st.markdown("""
    ### –£–º–Ω–∞—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –≤–∫–ª—é—á–∞–µ—Ç:
    
    **–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è —Å—Ç–æ–ø-—Å–ª–æ–≤:**
    - –û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏, –¥–æ–ª–∂–Ω–æ—Å—Ç–∏
    - –ü—Ä–µ–¥–ª–æ–≥–∏, —Å–æ—é–∑—ã
    - –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –Ω–∞–¥–ø–∏—Å–∏
    
    **–†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ –∏–º—ë–Ω:**
    - –ë–∞–∑–∞ —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω—ë–Ω–Ω—ã—Ö –∏–º—ë–Ω/—Ñ–∞–º–∏–ª–∏–π
    - –ü–∞—Ç—Ç–µ—Ä–Ω—ã –æ–∫–æ–Ω—á–∞–Ω–∏–π
    - –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞
    
    **–ü—Ä–µ–¥–æ–±—Ä–∞–±–æ—Ç–∫–∞:**
    - –£–≤–µ–ª–∏—á–µ–Ω–∏–µ –∫–æ–Ω—Ç—Ä–∞—Å—Ç–∞
    - –£–¥–∞–ª–µ–Ω–∏–µ —à—É–º–∞
    - –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è OCR
    """)


# === PWA –ü–û–î–î–ï–†–ñ–ö–ê ===
st.markdown("""
<script>
if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('/sw.js').catch(console.error);
}
</script>
<link rel="manifest" href="/manifest.json">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="–ü—Ä–æ–ø—É—Å–∫–∏">
""", unsafe_allow_html=True)